# Production Deployment Guide for Open Web Analytics

## For Coolify Deployment

### DNS Configuration

**IMPORTANT**: Make sure your domain DNS is properly configured in Coolify:

1. In Coolify, go to your application settings
2. Configure the domain: `analytics.pdevsecops.com`
3. Ensure DNS records are set up:
   - A record pointing to your Coolify server IP, OR
   - CNAME record pointing to your Coolify domain
4. Wait for DNS propagation (can take a few minutes to hours)

If you see `DNS_PROBE_FINISHED_NXDOMAIN`, it means DNS isn't configured yet. The application is working (as shown by the 302 redirect in logs), but the domain isn't resolving.

### 1. Environment Variables

**IMPORTANT**: In Coolify, when you link a database service to your application, Coolify automatically provides database connection environment variables. You need to map these to OWA's expected environment variables.

Set these environment variables in Coolify:

- `OWA_DB_HOST`: **This is critical!** Set this to your database service name. In Coolify, this is usually the database service name (e.g., `db-z4s0okcsgwco4wcssk8ogg8c-084342893874`). You can find this in your database service settings or use the Coolify-provided database hostname variable.
- `OWA_DB_NAME`: Database name (e.g., `owa` or use the Coolify database name variable)
- `OWA_DB_USER`: Database username (e.g., `owa_user` or use the Coolify database user variable)
- `OWA_DB_PASSWORD`: Database password (use the Coolify database password variable)
- `OWA_DB_PORT`: Database port (usually `3306`)
- `OWA_DB_TYPE`: Database type (set to `mysql`)
- `OWA_PUBLIC_URL`: Your public URL (e.g., `https://analytics.pdevsecops.com/`)

**Note**: The `deploy-init.sh` script will automatically update `owa-config.php` with these environment variables when the container starts. This ensures the config file always has the correct database host, even if it's dynamically generated by Coolify.

### 2. Config File

The `owa-config.php` file will be automatically created from the template on first container start. However, you need to configure it:

**Option A: Use Installation Wizard**
1. Access `http://analytics.pdevsecops.com/install.php`
2. Follow the installation wizard
3. It will create the config file automatically

**Option B: Create Config File Manually**

Create `owa-config.php` in the root directory with:

```php
<?php
define('OWA_DB_TYPE', 'mysql');
define('OWA_DB_NAME', 'owa');
define('OWA_DB_HOST', 'db'); // or your database host
define('OWA_DB_USER', 'owa_user');
define('OWA_DB_PASSWORD', 'owa_password');
define('OWA_DB_PORT', '3306');
define('OWA_PUBLIC_URL', 'http://analytics.pdevsecops.com/');
define('OWA_NONCE_KEY', 'your-random-key-here');
define('OWA_NONCE_SALT', 'your-random-salt-here');
define('OWA_AUTH_KEY', 'your-random-auth-key-here');
define('OWA_AUTH_SALT', 'your-random-auth-salt-here');
?>
```

### 3. Database Setup

Make sure your database is set up and accessible. The application will create tables during installation.

### 4. File Permissions

The Docker container will set proper permissions automatically. If you need to set them manually:

```bash
chmod 644 owa-config.php
chmod -R 755 owa-data
```

### 5. First Access

1. Go to `http://analytics.pdevsecops.com/install.php`
2. Complete the installation wizard
3. Create an admin user
4. Access the application at `http://analytics.pdevsecops.com/`

## Troubleshooting

### Config File Not Found

If you see "Failed to open stream" errors:
- The application will automatically redirect to `install.php` if config file doesn't exist
- Create the config file manually or run the installation wizard

### Database Connection Issues

**Most Common Issue in Coolify**: The database host is incorrect.

1. **Find your database service name in Coolify**:
   - Go to your database service in Coolify
   - Look at the service name/container name (e.g., `db-z4s0okcsgwco4wcssk8ogg8c-093314688937`)
   - This is visible in the database service logs or settings
   - **This is the value you need for `OWA_DB_HOST`**

2. **Set the environment variable correctly**:
   - In Coolify, go to your **application** (not the database service)
   - Go to Environment Variables
   - Set `OWA_DB_HOST` to the exact database service name from step 1
   - Example: `OWA_DB_HOST=db-z4s0okcsgwco4wcssk8ogg8c-093314688937`
   - **Important**: Do NOT use `localhost`, `127.0.0.1`, or `db` - use the actual service name

2. **Verify environment variables are set**:
   - In Coolify, go to your application settings
   - Check that all `OWA_DB_*` environment variables are set
   - The `deploy-init.sh` script will automatically update the config file with these values

3. **Check database connectivity**:
   - Verify the database service is running
   - Ensure the database service is linked to your application in Coolify
   - Check that the database hostname resolves correctly (you can exec into the container and try `ping $OWA_DB_HOST`)

4. **Verify database credentials**:
   - Check `owa-config.php` has the correct values (the script updates it automatically)
   - Ensure database user has proper permissions
   - Verify database name exists

5. **Check logs**:
   - Look for database connection errors in the application logs
   - Check if the database is ready (MySQL initialization can take time)

### Database Host Not Resolving

If you see errors about the database host not being found:
- In Coolify, make sure the database service is linked to your application
- The database host should be the service name, not `localhost` or `127.0.0.1`
- Wait a few seconds after container startup for DNS to propagate

### Permission Issues

- Ensure `owa-data` directory is writable
- Check file permissions on `owa-config.php` (should be 644)

